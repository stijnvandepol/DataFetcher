<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin</title>
  <style>
    :root { --bg: #0a0e1a; --surface: #141929; --surface2: #1c2137; --border: #252d44; --text: #e2e8f0; --text2: #8892a8; --text3: #5a6478; --accent: #3b82f6; --accent-hover: #60a5fa; --green: #10b981; --green-bg: #0d3326; --red: #ef4444; --red-bg: #2a1015; --pink: #ec4899; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

    /* Topbar */
    .topbar { background: var(--surface); padding: 0 32px; display: flex; align-items: center; justify-content: space-between; height: 56px; border-bottom: 1px solid var(--border); }
    .topbar-brand { font-size: 16px; font-weight: 700; color: var(--text); display: flex; align-items: center; gap: 10px; }
    .topbar-brand span { color: var(--pink); }
    .topbar-nav { display: flex; gap: 8px; }
    .topbar-nav a { color: var(--text2); text-decoration: none; font-size: 13px; font-weight: 500; padding: 6px 14px; border-radius: 8px; transition: all .15s; }
    .topbar-nav a:hover { color: var(--text); background: var(--surface2); }

    .container { max-width: 1100px; margin: 0 auto; padding: 32px; }

    /* Panel card */
    .panel { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 24px 28px; margin-bottom: 24px; }
    .panel-header { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; padding-bottom: 14px; border-bottom: 1px solid var(--border); }
    .panel-header h2 { font-size: 15px; font-weight: 600; color: var(--text); }

    /* Access control */
    .access-row { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
    .badge { padding: 6px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; letter-spacing: .3px; }
    .badge.local { background: var(--green-bg); color: var(--green); border: 1px solid rgba(16,185,129,.2); }
    .badge.open { background: var(--red-bg); color: var(--red); border: 1px solid rgba(239,68,68,.2); }
    .btn { padding: 8px 20px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all .15s; }
    .btn-green { background: var(--green); color: #fff; }
    .btn-green:hover { filter: brightness(1.1); }
    .btn-red { background: var(--red); color: #fff; }
    .btn-red:hover { filter: brightness(1.1); }
    .btn-sm { padding: 5px 14px; font-size: 12px; border-radius: 6px; }
    .access-hint { margin-top: 16px; color: var(--text3); font-size: 13px; line-height: 1.6; }
    .access-hint strong { color: var(--text2); }

    /* Sessions table */
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    thead th { text-align: left; padding: 10px 14px; color: var(--text3); font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: .5px; border-bottom: 1px solid var(--border); }
    tbody td { padding: 10px 14px; border-bottom: 1px solid var(--border); color: var(--text2); }
    tbody tr:last-child td { border-bottom: none; }
    tbody tr:hover { background: var(--surface2); }
    tbody td code { font-family: 'SF Mono', 'Fira Code', monospace; font-size: 12px; color: var(--accent); background: rgba(59,130,246,.1); padding: 2px 8px; border-radius: 4px; }
    .ua-cell { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .empty-state { color: var(--text3); font-size: 14px; padding: 24px 0; text-align: center; }

    /* Audit log */
    .log { max-height: 360px; overflow-y: auto; font-family: 'SF Mono', 'Fira Code', monospace; font-size: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 10px; padding: 16px; }
    .log::-webkit-scrollbar { width: 6px; }
    .log::-webkit-scrollbar-track { background: transparent; }
    .log::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    .log-entry { padding: 4px 0; display: grid; grid-template-columns: 150px 120px 110px 1fr; gap: 8px; border-bottom: 1px solid rgba(37,45,68,.5); }
    .log-entry:last-child { border-bottom: none; }
    .log-time { color: var(--text3); }
    .log-ip { color: var(--accent); }
    .log-action { color: var(--pink); font-weight: 500; }
    .log-detail { color: var(--text2); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    /* Fetch panel */
    .fetch-row { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
    .btn-blue { background: var(--accent); color: #fff; }
    .btn-blue:hover { filter: brightness(1.15); }
    .btn-blue:disabled { opacity: .5; cursor: not-allowed; filter: none; }
    .fetch-status { color: var(--text2); font-size: 13px; }
    .fetch-status.running { color: var(--accent); }
    .fetch-status.done { color: var(--green); }
    .fetch-status.error { color: var(--red); }
    .fetch-stats { display: flex; gap: 24px; margin-top: 12px; font-size: 13px; color: var(--text2); }
    .fetch-stats strong { color: var(--text); }
    .fetch-log { max-height: 360px; overflow-y: auto; font-family: 'SF Mono', 'Fira Code', monospace; font-size: 11px; background: var(--bg); border: 1px solid var(--border); border-radius: 10px; padding: 12px 16px; margin-top: 16px; color: var(--text2); white-space: pre-wrap; word-break: break-all; display: block; min-height: 120px; }
    .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin .6s linear infinite; margin-right: 6px; vertical-align: middle; }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* Responsive */
    @media (max-width: 768px) {
      .topbar { padding: 0 16px; height: 52px; }
      .topbar-brand { font-size: 15px; }
      .topbar-nav { gap: 6px; }
      .topbar-nav a { font-size: 12px; padding: 6px 10px; }
      .container { padding: 16px; max-width: 100%; }
      .panel { padding: 16px; border-radius: 12px; margin-bottom: 16px; }
      .panel-header h2 { font-size: 14px; }
      .access-row, .fetch-row { flex-direction: column; align-items: stretch; gap: 12px; }
      .btn, .btn-green, .btn-red, .btn-blue { width: 100%; text-align: center; padding: 10px 20px; }
      .fetch-stats { flex-direction: column; gap: 8px; }
      /* Make table horizontally scrollable */
      .panel table { display: block; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; }
      .panel thead, .panel tbody { display: table; width: 100%; table-layout: fixed; }
      thead th { font-size: 10px; padding: 8px 10px; }
      tbody td { font-size: 12px; padding: 8px 10px; }
      .ua-cell { max-width: 150px; }
      .log { font-size: 11px; padding: 12px; max-height: 300px; }
      .log-entry { grid-template-columns: 1fr; gap: 4px; padding: 8px 0; }
      .log-time, .log-ip, .log-action { display: inline; }
      .log-time::after { content: ' | '; color: var(--text3); }
      .log-ip::after { content: ' | '; color: var(--text3); }
      .fetch-log { font-size: 10px; padding: 10px 12px; max-height: 220px; }
    }
    @media (max-width: 480px) {
      .topbar-brand span { display: none; }
      .badge { font-size: 11px; padding: 5px 12px; width: 100%; text-align: center; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-brand"><span>&#9679;</span> Admin Panel</div>
    <nav class="topbar-nav">
      <a href="/">Database</a>
      <a href="/logout">Uitloggen</a>
    </nav>
  </div>

  <div class="container">
    <!-- Data Fetch -->
    <div class="panel">
      <div class="panel-header"><h2>Data Fetchen</h2></div>
      
      <!-- Manual mode: URL of lokaal pad + DB Name -->
      <div style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid var(--border);">
        <p style="font-size: 12px; color: var(--text3); text-transform: uppercase; letter-spacing: .5px; margin-bottom: 12px; font-weight: 600;">Bestandsbron & Database</p>
        <div style="display: grid; grid-template-columns: 1fr 1fr 120px; gap: 12px; align-items: end;">
          <div style="display: flex; flex-direction: column; gap: 6px;">
            <label style="font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: .6px; color: var(--text3);">URL of lokaal pad (.7z of .txt)</label>
            <input type="text" id="fileUrl" placeholder="https://…/data.7z  of  /data/incoming/data.txt" style="padding: 12px 14px; border: 1px solid var(--border); border-radius: 10px; background: var(--bg); color: var(--text); font-size: 14px; outline: none; transition: border .2s, box-shadow .2s;">
          </div>
          <div style="display: flex; flex-direction: column; gap: 6px;">
            <label style="font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: .6px; color: var(--text3);">Database naam</label>
            <input type="text" id="dbName" placeholder="bv. klanten_01" style="padding: 12px 14px; border: 1px solid var(--border); border-radius: 10px; background: var(--bg); color: var(--text); font-size: 14px; outline: none; transition: border .2s, box-shadow .2s;">
          </div>
          <button id="fetchDirectBtn" class="btn btn-blue" onclick="startDirectFetch()" style="height: 44px;">Importeren</button>
        </div>
        <div class="fetch-row" style="margin-top: 10px;">
          <span id="fetchStatus" class="fetch-status">Geen actieve fetch</span>
        </div>

        <!-- Gebruiksinstructie -->
        <div style="margin-top: 16px; background: var(--bg); border: 1px solid var(--border); border-radius: 10px; padding: 16px 18px;">
          <p style="font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .6px; color: var(--text3); margin-bottom: 10px;">Hoe te gebruiken</p>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div>
              <p style="font-size: 12px; font-weight: 600; color: var(--accent); margin-bottom: 4px;">Lokaal .7z archief</p>
              <p style="font-size: 12px; color: var(--text2); line-height: 1.6;">Het archief wordt automatisch uitgepakt en geïmporteerd.</p>
              <code style="display: block; margin-top: 6px; font-size: 11px; color: var(--text3); background: var(--surface2); padding: 5px 8px; border-radius: 6px; word-break: break-all;">/data/incoming/export.7z</code>
            </div>
            <div>
              <p style="font-size: 12px; font-weight: 600; color: var(--green); margin-bottom: 4px;">Lokaal .txt bestand (al uitgepakt)</p>
              <p style="font-size: 12px; color: var(--text2); line-height: 1.6;">Direct importeren — geen extractie nodig.</p>
              <code style="display: block; margin-top: 6px; font-size: 11px; color: var(--text3); background: var(--surface2); padding: 5px 8px; border-radius: 6px; word-break: break-all;">/data/incoming/export.txt</code>
            </div>
            <div>
              <p style="font-size: 12px; font-weight: 600; color: var(--pink); margin-bottom: 4px;">Remote URL (.7z)</p>
              <p style="font-size: 12px; color: var(--text2); line-height: 1.6;">Downloadt, test en importeert automatisch. Ondersteunt alleen .7z.</p>
              <code style="display: block; margin-top: 6px; font-size: 11px; color: var(--text3); background: var(--surface2); padding: 5px 8px; border-radius: 6px; word-break: break-all;">https://example.com/data.7z</code>
            </div>
            <div>
              <p style="font-size: 12px; font-weight: 600; color: var(--text2); margin-bottom: 4px;">Database naam</p>
              <p style="font-size: 12px; color: var(--text2); line-height: 1.6;">Kies een unieke naam. Dezelfde naam importeert in dezelfde tabel (duplicaten worden overgeslagen).</p>
            </div>
          </div>
          <p style="font-size: 11px; color: var(--text3); margin-top: 12px; padding-top: 10px; border-top: 1px solid var(--border);">
            Lokale bestanden moeten in de gemounte map staan (standaard <code style="font-size: 11px; color: var(--accent);">/data/incoming/</code> in de container). Controleer je <code style="font-size: 11px; color: var(--accent);">docker-compose.yml</code> voor de volume-koppeling.
          </p>
        </div>
      </div>

      <div class="fetch-stats" id="fetchStats" style="display:none">
        <span>Bestanden: <strong id="fetchFiles">0</strong></span>
        <span>Rijen: <strong id="fetchRows">0</strong></span>
        <span id="fetchTime"></span>
      </div>
      <div class="fetch-log" id="fetchLog"></div>
      <p class="access-hint" style="margin-top:12px">
        De database blijft altijd draaien en bestaande gegevens worden niet verwijderd. Duplicaten worden automatisch overgeslagen.
      </p>
    </div>

    <!-- Databases Overview -->
    <div class="panel">
      <div class="panel-header"><h2>Databases (Tabellen)</h2></div>
      <div id="tablesContainer" style="display: none;">
        <table id="tablesTable" style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr>
              <th style="text-align: left; padding: 10px 14px; color: var(--text3); font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: .5px; border-bottom: 1px solid var(--border);">Tabelnaam</th>
              <th style="text-align: right; padding: 10px 14px; color: var(--text3); font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: .5px; border-bottom: 1px solid var(--border);">Aantal rijen</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p id="noTables" style="color: var(--text3); font-size: 14px; padding: 24px 0; text-align: center;">Geen tabellen gevonden</p>
    </div>

    <!-- Active Sessions -->
    <div class="panel">
      <div class="panel-header"><h2>Actieve sessies ({{ total_sessions }})</h2></div>
      {% if sessions %}
      <table>
        <thead>
          <tr>
            <th>Sessie</th>
            <th>IP</th>
            <th>User Agent</th>
            <th>Login</th>
            <th>Laatst actief</th>
            <th>Idle</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for s in sessions %}
          <tr>
            <td><code>{{ s.sid_short }}</code></td>
            <td>{{ s.ip }}</td>
            <td class="ua-cell" title="{{ s.user_agent }}">{{ s.user_agent }}</td>
            <td>{{ s.login_time }}</td>
            <td>{{ s.last_seen }}</td>
            <td>{{ s.idle }}</td>
            <td>
              <form method="POST" action="/admin/kick" style="display:inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="sid" value="{{ s.sid_short }}">
                <button class="btn btn-red btn-sm">Kick</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="empty-state">Geen actieve sessies</p>
      {% endif %}
    </div>

    <!-- Audit Log -->
    <div class="panel">
      <div class="panel-header"><h2>Audit log</h2></div>
      <div class="log">
        {% for entry in audit_log %}
        <div class="log-entry">
          <span class="log-time">{{ entry.time }}</span>
          <span class="log-ip">{{ entry.ip }}</span>
          <span class="log-action">{{ entry.action }}</span>
          <span class="log-detail">{{ entry.detail }}</span>
        </div>
        {% endfor %}
        {% if not audit_log %}
        <p class="empty-state">Geen activiteit gelogd</p>
        {% endif %}
      </div>
    </div>
  </div>

  <script>
    let polling = false;
    let pollTimer = null;
    const csrfToken = '{{ csrf_token() }}';

    function startDirectFetch() {
      const fileUrl = document.getElementById('fileUrl').value.trim();
      const dbName = document.getElementById('dbName').value.trim();
      const btn = document.getElementById('fetchDirectBtn');

      if (!fileUrl || !dbName) {
        alert('Vul zowel URL als database naam in');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Bezig...';

      fetch('/admin/fetch', {
        method: 'POST',
        headers: {
          'X-CSRF-Token': csrfToken,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ file_url: fileUrl, db_name: dbName }),
      })
        .then(r => r.json())
        .then(data => {
          if (data.ok) {
            // Clear input fields
            document.getElementById('fileUrl').value = '';
            document.getElementById('dbName').value = '';
            startPolling();
          } else {
            btn.disabled = false;
            btn.textContent = 'Importeren';
            alert(data.error || 'Fout bij starten');
          }
        })
        .catch(() => {
          btn.disabled = false;
          btn.textContent = 'Importeren';
          alert('Netwerkfout');
        });
    }

    function startPolling() {
      if (polling) return;
      polling = true;
      pollStatus();
    }

    function pollStatus() {
      fetch('/admin/fetch/status')
        .then(r => r.json())
        .then(updateUI)
        .catch(() => {});
      pollTimer = setTimeout(pollStatus, 1500);
    }

    function updateUI(s) {
      const btn = document.getElementById('fetchBtn');
      const directBtn = document.getElementById('fetchDirectBtn');
      const status = document.getElementById('fetchStatus');
      const stats = document.getElementById('fetchStats');
      const logEl = document.getElementById('fetchLog');
      const filesEl = document.getElementById('fetchFiles');
      const rowsEl = document.getElementById('fetchRows');
      const timeEl = document.getElementById('fetchTime');

      if (s.running) {
        if (btn) {
          btn.disabled = true;
          btn.innerHTML = '<span class="spinner"></span>Bezig...';
        }
        directBtn.disabled = true;
        directBtn.innerHTML = '<span class="spinner"></span>Bezig...';
        status.className = 'fetch-status running';
        status.textContent = s.progress || 'Bezig...';
      } else {
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Auto Fetch starten';
        }
        directBtn.disabled = false;
        directBtn.textContent = 'Importeren';
        if (s.error) {
          status.className = 'fetch-status error';
          status.textContent = 'Fout: ' + s.error;
        } else if (s.finished_at) {
          status.className = 'fetch-status done';
          status.textContent = s.progress || 'Klaar';
        } else {
          status.className = 'fetch-status';
          status.textContent = 'Geen actieve fetch';
        }
        // Stop polling
        if (polling) {
          polling = false;
          clearTimeout(pollTimer);
        }
      }

      if (s.files_imported > 0 || s.total_rows > 0 || s.running) {
        stats.style.display = 'flex';
        filesEl.textContent = s.files_imported;
        rowsEl.textContent = s.total_rows.toLocaleString('nl-NL');
        if (s.started_at) {
          const started = new Date(s.started_at);
          const elapsed = Math.round((Date.now() - started.getTime()) / 1000);
          if (s.running) {
            timeEl.textContent = 'Looptijd: ' + elapsed + 's';
          } else if (s.finished_at) {
            const finished = new Date(s.finished_at);
            const dur = Math.round((finished - started) / 1000);
            timeEl.textContent = 'Duur: ' + dur + 's';
          }
        }
      }

      if (s.log && s.log.length > 0) {
        logEl.textContent = s.log.join('\n');
        logEl.scrollTop = logEl.scrollHeight;
      } else if (!s.log || s.log.length === 0) {
        logEl.textContent = 'Wachten op logs...';
      }
    }

    // Check initial status on page load
    fetch('/admin/fetch/status')
      .then(r => r.json())
      .then(s => {
        updateUI(s);
        if (s.running) startPolling();
      })
      .catch(() => {});

    // Load and display tables
    function loadTables() {
      fetch('/admin/tables')
        .then(r => r.json())
        .then(data => {
          const tables = data.tables || [];
          const container = document.getElementById('tablesContainer');
          const noTables = document.getElementById('noTables');
          const tbody = document.querySelector('#tablesTable tbody');
          
          if (tables.length === 0) {
            container.style.display = 'none';
            noTables.style.display = 'block';
            return;
          }
          
          container.style.display = 'block';
          noTables.style.display = 'none';
          tbody.innerHTML = '';
          
          tables.forEach(table => {
            const row = document.createElement('tr');
            row.style.borderBottom = '1px solid var(--border)';
            row.innerHTML = `
              <td style="padding: 10px 14px; color: var(--text2);">${escapeHtml(table.name)}</td>
              <td style="padding: 10px 14px; color: var(--text2); text-align: right;">${table.rows.toLocaleString('nl-NL')}</td>
            `;
            tbody.appendChild(row);
          });
        })
        .catch(() => {});
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Load tables on page load and refresh every 30 seconds
    loadTables();
    setInterval(loadTables, 30000);
  </script>
</body>
</html>
