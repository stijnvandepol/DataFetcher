<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin</title>
  <style>
    :root { --bg: #0a0e1a; --surface: #141929; --surface2: #1c2137; --border: #252d44; --text: #e2e8f0; --text2: #8892a8; --text3: #5a6478; --accent: #3b82f6; --accent-hover: #60a5fa; --green: #10b981; --green-bg: #0d3326; --red: #ef4444; --red-bg: #2a1015; --pink: #ec4899; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

    /* Topbar */
    .topbar { background: var(--surface); padding: 0 32px; display: flex; align-items: center; justify-content: space-between; height: 56px; border-bottom: 1px solid var(--border); }
    .topbar-brand { font-size: 16px; font-weight: 700; color: var(--text); display: flex; align-items: center; gap: 10px; }
    .topbar-brand span { color: var(--pink); }
    .topbar-nav { display: flex; gap: 8px; }
    .topbar-nav a { color: var(--text2); text-decoration: none; font-size: 13px; font-weight: 500; padding: 6px 14px; border-radius: 8px; transition: all .15s; }
    .topbar-nav a:hover { color: var(--text); background: var(--surface2); }

    .container { max-width: 1100px; margin: 0 auto; padding: 32px; }

    /* Panel card */
    .panel { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 24px 28px; margin-bottom: 24px; }
    .panel-header { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; padding-bottom: 14px; border-bottom: 1px solid var(--border); }
    .panel-header h2 { font-size: 15px; font-weight: 600; color: var(--text); }

    /* Access control */
    .access-row { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
    .badge { padding: 6px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; letter-spacing: .3px; }
    .badge.local { background: var(--green-bg); color: var(--green); border: 1px solid rgba(16,185,129,.2); }
    .badge.open { background: var(--red-bg); color: var(--red); border: 1px solid rgba(239,68,68,.2); }
    .btn { padding: 8px 20px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all .15s; }
    .btn-green { background: var(--green); color: #fff; }
    .btn-green:hover { filter: brightness(1.1); }
    .btn-red { background: var(--red); color: #fff; }
    .btn-red:hover { filter: brightness(1.1); }
    .btn-sm { padding: 5px 14px; font-size: 12px; border-radius: 6px; }
    .access-hint { margin-top: 16px; color: var(--text3); font-size: 13px; line-height: 1.6; }
    .access-hint strong { color: var(--text2); }

    /* Sessions table */
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    thead th { text-align: left; padding: 10px 14px; color: var(--text3); font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: .5px; border-bottom: 1px solid var(--border); }
    tbody td { padding: 10px 14px; border-bottom: 1px solid var(--border); color: var(--text2); }
    tbody tr:last-child td { border-bottom: none; }
    tbody tr:hover { background: var(--surface2); }
    tbody td code { font-family: 'SF Mono', 'Fira Code', monospace; font-size: 12px; color: var(--accent); background: rgba(59,130,246,.1); padding: 2px 8px; border-radius: 4px; }
    .ua-cell { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .empty-state { color: var(--text3); font-size: 14px; padding: 24px 0; text-align: center; }

    /* Audit log */
    .log { max-height: 360px; overflow-y: auto; font-family: 'SF Mono', 'Fira Code', monospace; font-size: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 10px; padding: 16px; }
    .log::-webkit-scrollbar { width: 6px; }
    .log::-webkit-scrollbar-track { background: transparent; }
    .log::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    .log-entry { padding: 4px 0; display: grid; grid-template-columns: 150px 120px 110px 1fr; gap: 8px; border-bottom: 1px solid rgba(37,45,68,.5); }
    .log-entry:last-child { border-bottom: none; }
    .log-time { color: var(--text3); }
    .log-ip { color: var(--accent); }
    .log-action { color: var(--pink); font-weight: 500; }
    .log-detail { color: var(--text2); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    /* Fetch panel */
    .fetch-row { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
    .btn-blue { background: var(--accent); color: #fff; }
    .btn-blue:hover { filter: brightness(1.15); }
    .btn-blue:disabled { opacity: .5; cursor: not-allowed; filter: none; }
    .fetch-status { color: var(--text2); font-size: 13px; }
    .fetch-status.running { color: var(--accent); }
    .fetch-status.done { color: var(--green); }
    .fetch-status.error { color: var(--red); }
    .fetch-stats { display: flex; gap: 24px; margin-top: 12px; font-size: 13px; color: var(--text2); }
    .fetch-stats strong { color: var(--text); }
    .fetch-log { max-height: 260px; overflow-y: auto; font-family: 'SF Mono', 'Fira Code', monospace; font-size: 11px; background: var(--bg); border: 1px solid var(--border); border-radius: 10px; padding: 12px 16px; margin-top: 16px; color: var(--text2); white-space: pre-wrap; word-break: break-all; display: none; }
    .fetch-log.visible { display: block; }
    .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin .6s linear infinite; margin-right: 6px; vertical-align: middle; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-brand"><span>&#9679;</span> Admin Panel</div>
    <nav class="topbar-nav">
      <a href="/">Database</a>
      <a href="/logout">Uitloggen</a>
    </nav>
  </div>

  <div class="container">
    <!-- Access Control -->
    <div class="panel">
      <div class="panel-header"><h2>Toegangsbeheer</h2></div>
      <div class="access-row">
        <span style="color:var(--text2);font-size:13px">Modus:</span>
        <span class="badge {{ 'local' if access_mode == 'local' else 'open' }}">
          {{ 'LOCALHOST' if access_mode == 'local' else 'OPEN' }}
        </span>
        <form method="POST" action="/admin/access" style="display:inline">
          {% if access_mode == 'local' %}
          <input type="hidden" name="mode" value="open">
          <button class="btn btn-red" onclick="return confirm('Externe toegang inschakelen?')">Extern openzetten</button>
          {% else %}
          <input type="hidden" name="mode" value="local">
          <button class="btn btn-green">Alleen localhost</button>
          {% endif %}
        </form>
      </div>
      <p class="access-hint">
        <strong>Localhost:</strong> Alleen bereikbaar via 127.0.0.1 en lokaal netwerk.<br>
        <strong>Open:</strong> Bereikbaar via elk IP-adres (wachtwoord vereist).
      </p>
    </div>

    <!-- Data Fetch -->
    <div class="panel">
      <div class="panel-header"><h2>Data Fetchen</h2></div>
      <div class="fetch-row">
        <button id="fetchBtn" class="btn btn-blue" onclick="startFetch()">Fetch starten</button>
        <span id="fetchStatus" class="fetch-status">Geen actieve fetch</span>
      </div>
      <div class="fetch-stats" id="fetchStats" style="display:none">
        <span>Bestanden: <strong id="fetchFiles">0</strong></span>
        <span>Rijen: <strong id="fetchRows">0</strong></span>
        <span id="fetchTime"></span>
      </div>
      <div class="fetch-log" id="fetchLog"></div>
      <p class="access-hint" style="margin-top:12px">
        Klik op <strong>Fetch starten</strong> om de bron te scannen op nieuwe data en te importeren.
      </p>
    </div>

    <!-- Active Sessions -->
    <div class="panel">
      <div class="panel-header"><h2>Actieve sessies ({{ total_sessions }})</h2></div>
      {% if sessions %}
      <table>
        <thead>
          <tr>
            <th>Sessie</th>
            <th>IP</th>
            <th>User Agent</th>
            <th>Login</th>
            <th>Laatst actief</th>
            <th>Idle</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for s in sessions %}
          <tr>
            <td><code>{{ s.sid_short }}</code></td>
            <td>{{ s.ip }}</td>
            <td class="ua-cell" title="{{ s.user_agent }}">{{ s.user_agent }}</td>
            <td>{{ s.login_time }}</td>
            <td>{{ s.last_seen }}</td>
            <td>{{ s.idle }}</td>
            <td>
              <form method="POST" action="/admin/kick" style="display:inline">
                <input type="hidden" name="sid" value="{{ s.sid_short }}">
                <button class="btn btn-red btn-sm">Kick</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="empty-state">Geen actieve sessies</p>
      {% endif %}
    </div>

    <!-- Audit Log -->
    <div class="panel">
      <div class="panel-header"><h2>Audit log</h2></div>
      <div class="log">
        {% for entry in audit_log %}
        <div class="log-entry">
          <span class="log-time">{{ entry.time }}</span>
          <span class="log-ip">{{ entry.ip }}</span>
          <span class="log-action">{{ entry.action }}</span>
          <span class="log-detail">{{ entry.detail }}</span>
        </div>
        {% endfor %}
        {% if not audit_log %}
        <p class="empty-state">Geen activiteit gelogd</p>
        {% endif %}
      </div>
    </div>
  </div>

  <script>
    let polling = false;
    let pollTimer = null;

    function startFetch() {
      const btn = document.getElementById('fetchBtn');
      btn.disabled = true;
      btn.textContent = 'Bezig...';

      fetch('/admin/fetch', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
          if (data.ok) {
            startPolling();
          } else {
            btn.disabled = false;
            btn.textContent = 'Fetch starten';
            alert(data.error || 'Fout bij starten');
          }
        })
        .catch(() => {
          btn.disabled = false;
          btn.textContent = 'Fetch starten';
          alert('Netwerkfout');
        });
    }

    function startPolling() {
      if (polling) return;
      polling = true;
      pollStatus();
    }

    function pollStatus() {
      fetch('/admin/fetch/status')
        .then(r => r.json())
        .then(updateUI)
        .catch(() => {});
      pollTimer = setTimeout(pollStatus, 1500);
    }

    function updateUI(s) {
      const btn = document.getElementById('fetchBtn');
      const status = document.getElementById('fetchStatus');
      const stats = document.getElementById('fetchStats');
      const logEl = document.getElementById('fetchLog');
      const filesEl = document.getElementById('fetchFiles');
      const rowsEl = document.getElementById('fetchRows');
      const timeEl = document.getElementById('fetchTime');

      if (s.running) {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span>Bezig...';
        status.className = 'fetch-status running';
        status.textContent = s.progress || 'Bezig...';
      } else {
        btn.disabled = false;
        btn.textContent = 'Fetch starten';
        if (s.error) {
          status.className = 'fetch-status error';
          status.textContent = 'Fout: ' + s.error;
        } else if (s.finished_at) {
          status.className = 'fetch-status done';
          status.textContent = s.progress || 'Klaar';
        } else {
          status.className = 'fetch-status';
          status.textContent = 'Geen actieve fetch';
        }
        // Stop polling
        if (polling) {
          polling = false;
          clearTimeout(pollTimer);
        }
      }

      if (s.files_imported > 0 || s.total_rows > 0 || s.running) {
        stats.style.display = 'flex';
        filesEl.textContent = s.files_imported;
        rowsEl.textContent = s.total_rows.toLocaleString('nl-NL');
        if (s.started_at) {
          const started = new Date(s.started_at);
          const elapsed = Math.round((Date.now() - started.getTime()) / 1000);
          if (s.running) {
            timeEl.textContent = 'Looptijd: ' + elapsed + 's';
          } else if (s.finished_at) {
            const finished = new Date(s.finished_at);
            const dur = Math.round((finished - started) / 1000);
            timeEl.textContent = 'Duur: ' + dur + 's';
          }
        }
      }

      if (s.log && s.log.length > 0) {
        logEl.classList.add('visible');
        logEl.textContent = s.log.join('\n');
        logEl.scrollTop = logEl.scrollHeight;
      }
    }

    // Check initial status on page load
    fetch('/admin/fetch/status')
      .then(r => r.json())
      .then(s => {
        updateUI(s);
        if (s.running) startPolling();
      })
      .catch(() => {});
  </script>
</body>
</html>
